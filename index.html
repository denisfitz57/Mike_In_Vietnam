<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notes From Mike About Vietnam — Interactive (Public Q&A)</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#111825;--ink:#e6edf6;--muted:#9ab;--accent:#7dd3fc;--line:#1f2937;--good:#22c55e;--bad:#ef4444;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px 64px;}
    h1{font-weight:800;letter-spacing:.2px;margin:0 0 6px;font-size:clamp(22px,3vw,34px);} 
    p.lead{color:var(--muted);margin:0 0 24px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 22px;color:var(--muted);}
    .meta code{background:#0d1320;border:1px solid #1b2436;padding:2px 6px;border-radius:6px;color:#cfe1ff}

    details{border:1px solid var(--line);border-radius:12px;background:var(--panel);margin:14px 0;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    summary{cursor:pointer;list-style:none;padding:14px 18px;display:flex;align-items:center;gap:12px}
    summary::-webkit-details-marker{display:none}
    .chev{inline-size:12px;block-size:12px;border-right:2px solid var(--muted);border-bottom:2px solid var(--muted);transform:rotate(-45deg);transition:.2s}
    details[open] .chev{transform:rotate(45deg)}
    .tagline{font-weight:700}
    .para{padding:12px 18px 4px;border-top:1px dashed var(--line);}

    /* Sentence chips */
    .sent{display:inline;position:relative;padding:2px 0;border-radius:6px}
    .sent:hover{background:rgba(125,211,252,.12);cursor:pointer}
    .sent:focus-visible{outline:2px solid var(--accent)}

    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;color:var(--muted);font-size:14px;margin:6px 0 10px}
    .toolbar .hint{opacity:.9}
    .comments{border-top:1px dashed var(--line);margin-top:10px;padding:10px 0 16px}
    .comment{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#0d1422}
    .comment .who{font-weight:700}
    .comment .when{font-size:12px;color:var(--muted)}
    .reply{border-left:3px solid #1f3a2e;padding-left:10px;margin-top:8px}
    .empty{color:var(--muted);font-style:italic}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal[aria-hidden="false"]{display:flex}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:680px;width:100%;padding:18px}
    .card h2{margin:0 0 6px;font-size:20px}
    .card p{margin:0 0 12px;color:var(--muted)}
    .field{display:grid;gap:6px;margin:10px 0}
    .field textarea{min-height:120px}
    input,textarea{background:#0c1220;border:1px solid #1b2436;border-radius:10px;padding:10px;color:var(--ink);font:inherit}
    label{font-weight:600}
    .btnrow{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    button{border:1px solid #223049;background:#0f1729;color:var(--ink);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#075985}
    .btn-ghost{background:transparent}
    .toast{position:fixed;right:16px;bottom:16px;background:#06210f;color:#d1fae5;border:1px solid #14532d;padding:10px 14px;border-radius:10px;display:none}
    .toast.show{display:block}
    .small{font-size:13px;color:var(--muted)}
    a{color:#86e1ff}
    .foot{margin-top:28px;color:var(--muted);font-size:14px;visibility: hidden}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Notes From Mike About Vietnam</h1>
    <p class="lead">Click a tagline to reveal the paragraph. Click any sentence to comment or ask a question. Notes and replies are public.</p>

    <div class="meta">
      <div>Reveal/Hide: click the heading below</div>
      <div>Comment: click a sentence</div>
      <div>Public Q&A: below each paragraph</div>
    </div>

    <section id="accordion"></section>

    <section class="foot">
      <p class="small">Hosting: commit this file to a GitHub repo and enable GitHub Pages (<span class="mono">main</span> → <span class="mono">/root</span>).</p>
      <details>
        <summary><span class="chev"></span><span class="tagline">Setup Instructions — Google Sheets backend</span></summary>
        <div class="para">
          <ol>
            <li><strong>Create a Google Sheet</strong> with columns (row 1 headers):<br><span class="mono">timestamp, paragraph_index, sentence_index, sentence_text, note, from_email, status, maintainer_reply, reply_timestamp, ip, user_agent</span></li>
            <li><strong>Open Extensions → Apps Script</strong>, create a script, paste the code from the <em>Apps Script</em> section at the bottom of this file.</li>
            <li>In the script, set <span class="mono">SHEET_ID</span> to your Sheet’s ID and <span class="mono">SHEET_NAME</span> to your tab name (e.g., <span class="mono">Sheet1</span>).</li>
            <li><strong>Deploy</strong>: Apps Script → Deploy → <em>New deployment</em> → <em>Web app</em> → Execute as: <em>Me</em>; Who has access: <em>Anyone</em>. Copy the web app URL.</li>
            <li>Back here, set <span class="mono">SCRIPT_URL</span> below to that web app URL and publish the site.</li>
            <li>Maintainer replies by typing in the <span class="mono">maintainer_reply</span> column (and optionally <span class="mono">status</span>), which shows up publicly on the page.</li>
          </ol>
          <p class="small">Privacy: end-user emails are stored in the sheet but only an obfuscated form is displayed on the page.</p>
        </div>
      </details>

      <details>
        <summary><span class="chev"></span><span class="tagline">Apps Script (paste into Extensions → Apps Script)</span></summary>
        <div class="para">
<pre class="small"><code>// ===== Google Apps Script: publish as Web App =====
// Set your sheet info
const SHEET_ID   = 'YOUR_SHEET_ID_HERE';
const SHEET_NAME = 'Sheet1';

function doGet(e){
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const rows = sheet.getDataRange().getValues();
  const headers = rows.shift();
  const out = rows.map(r => Object.fromEntries(headers.map((h,i)=>[String(h), r[i]])));
  return json(out);
}

function doPost(e){
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const now = new Date();
  let payload = {};
  try { payload = JSON.parse(e.postData.contents); } catch(err) {}
  // Simple spam honeypot: reject if hidden field is filled
  if ((payload.honeypot||'').trim() !== '') return json({ok:false, error:'spam'}, 400);

  const ip = (e?.parameter?.user_ip) || getIp(e) || '';
  const ua = e?.postData?.type ? (e?.postData?.contents ? '' : '') : (e?.parameter?.user_agent || '');

  const row = [
    now,
    Number(payload.paragraphIndex)||'',
    Number(payload.sentenceIndex)||'',
    payload.sentenceText||'',
    payload.note||'',
    payload.fromEmail||'',
    'new',
    '',
    '',
    ip,
    ua
  ];
  sheet.appendRow(row);
  return json({ok:true});
}

function getIp(e){
  try{ return e?.context?.clientIp || e?.parameter?.ip || ''; }catch(err){return ''}
}

function json(obj, code){
  const out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  return out;
}
</code></pre>
<p class="small">Note: Apps Script Web App responses are JSON. If you need strict CORS headers for certain hosts, switch to <span class="mono">HtmlService.createHtmlOutput</span> with <span class="mono">setXFrameOptionsMode</span> and serve JSON via script tag or add a simple <em>doOptions</em> handler; most setups work as-is.</p>
        </div>
      </details>
    </section>
  </main>

  <!-- Comment Modal -->
  <div class="modal" id="noteModal" aria-hidden="true" role="dialog" aria-labelledby="noteTitle">
    <div class="card" role="document">
      <h2 id="noteTitle">Public note on this sentence</h2>
      <p id="noteContext" class="small"></p>
      <form id="noteForm">
        <div class="field" hidden>
          <!-- Honeypot for spam bots -->
          <label for="website">Website</label>
          <input id="website" name="website" type="text" autocomplete="off" />
        </div>
        <div class="field">
          <label for="noteText">Your note (public)</label>
          <textarea id="noteText" name="note" placeholder="Your comment or question..." required></textarea>
        </div>
        <div class="field">
          <label for="noteEmail">Your email (not shown publicly; for notifications/replies)</label>
          <input id="noteEmail" name="email" type="email" placeholder="you@example.com" required />
        </div>
        <input type="hidden" name="paragraph" id="noteParagraph" />
        <input type="hidden" name="sentence" id="noteSentence" />
        <div class="btnrow">
          <button type="button" class="btn-ghost" id="btnCancel">Cancel</button>
          <button type="submit" class="btn-primary">Submit public note</button>
        </div>
        <p class="small">Your note will be publicly visible after submission. Maintainer’s reply (added in the sheet) will appear here automatically.</p>
      </form>
    </div>
  </div>

  <div class="toast" id="toast">Saved.</div>

  <script>
    // ======= CONFIG =======
    // 1) After deploying your Apps Script as a Web App, paste the URL here:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVniGLs8WDaMmPZtgbIl6u_awoa9k57DDW7wZRDVKdjgNaP6Q5CD5L4a6JCIsNXK45TQ/exec"; // TODO: set this

    // ======= DATA: Taglines + Paragraphs =======
    const items = [
      { tag: "Baptism by Fire", txt: "I’ve been in Viet Nam a little over a week and already I’ve taken three AK-47 rounds and probably killed enough men to become an “ace” in Air Force terms. What will the next twelve months bring?" },
      { tag: "Trained to Kill, Not to Grieve", txt: "I was trained to kill and when it’s “kill or be killed” there is no emotional baggage doing your job. No training can prepare you for the death of a friend. Luckily, I didn’t know any of the sixteen who were killed very well, so the pain was not too great." },
      { tag: "Wounded Yet Unaware", txt: "Those who were seriously wounded were sent to a hospital ship, I thought I was just grazed in the arm and leg, so I went back to our ship, which had four or five doctors. When I was examined, they found I was shot through the right upper leg and should have gone to the hospital ship. But since I was here, I would stay. My arm was stitched up right away but they waited a week to sew up my leg. Every day they would change the packing all through my leg, talk about pain! The doctor made one stitch in my leg, I was given a local, so I watched the whole operation, but when he tied the stitch and left 3 inches of excess sutures, he just stuffed the excess sutures into my leg. I was thinking to myself, “This just doesn’t seem right.” If it was not for the Demerol in me, I am sure I would have said something. But I told myself he is the doctor and knows what is best." },
      { tag: "Bleeding Through the Pain", txt: "About two weeks later I was mopping the shower room and my right foot got real slippery in my shower shoe. I just thought I stepped into water but then someone said, “Man, you’re bleeding!” Now I know I should have questioned the doctor. I think I was bleeding more now than when I got shot!" },
      { tag: "Thrown Back Into Battle", txt: "I was out of action for forty days after I was shot, and now it was time to go back to war. Our entire unit had to leave because a U.S.O. show was coming to the ship and the upper brass didn’t want a bunch of crazy Marines acting like a bunch of … well Marines! We were helo’d off the ship and set up about ten miles south of the DMZ. My foxhole was right on the edge of a small canal probable twenty feet across. Sometime in the middle of the first night a frog jumped into the water, and I was only 99% sure it was a frog. The other one percent told me it was the enemy. Fear gripped me so hard, and my heart was beating so fiercely, it actually caused pain. Although I knew it was a frog, fear overtook me and I threw a grenade into the water. I don’t know if I killed the frog but if there was a NVA he was gone! We didn’t find any bodies the next day: man or frog. I did catch a lot of crap for a long time though. Even now, that was the scariest moment of my life." },
      { tag: "Fear in the Night", txt: "One night I was the head of an outpost (three guys). We were about 100 yards in front of the lines. The purpose of an outpost is to see or hear in time to warn the main body. My lieutenant saw some red lights and informed me they were aiming lights for rockets and told me to call in artillery to destroy the lights and the enemy. I called in a few rounds and adjusted the distance and then had them fire for effect (a lot of rounds). I then realized they were only fireflies and told my Lt. He disagreed. So, I spent the rest of the night trying to kill fireflies with a 105mm howitzer... I believe I failed and suspect my tax dollars are still paying that bill off." },
      { tag: "Revenge and Responsibility", txt: "Probably the lowest point in my life was in the summer of 1968. Our Company (120 men) came upon an abandoned village a few miles south of the DMZ at twilight. One squad, 8 or 10 Marines, was ambushed and all were killed. The NVA shot them all in the head afterwards, to be sure they were dead. We could do nothing that night, but at first light we had the village almost surrounded. The NVA all tried to escape to the north and we killed them all. That was about 100 to 150 of the enemy. But we took one causality that day. I was a fire team leader, and I was in charge of three Marines. Richard “CARL” Madison was only standing 5 feet from me and he took a round a few inches below his left shoulder. He died in my arms." },
      { tag: "Haunted by Carl", txt: "Carl was a friend, and I felt responsible. Although about twenty of us were all standing up shooting, we should have been laying down shooting. I think about Carl almost every day of my life and that was thirty-five years ago. That is what war is about." },
      { tag: "A Missed Death by a Day", txt: "I once missed death by exactly 24 hours. We were building a base called A-4, along the DMZ. On the first night nothing happened but the rain. Lots of rain. We slept and did our watch in foxholes. We had to bail water out every hour. The next night I was on a three-man outpost about 50 yards in front of the lines. In the middle of the night we heard an explosion toward our lines, when I went back to the lines the next morning, I found out an artillery round hit my previous night’s foxhole and killed all three Marines. It was H & I fire, (harassment and interdiction). Supposedly all friendly positions in Vietnam were plotted so US artillery could fire into enemy territory just to unnerve them. Friendly fire killed those men!" },
      { tag: "Comedy Amid Chaos", txt: "War wasn’t always serious. During the Tet Offensive of ’68 (Jan. 30/31), we were taken out of the bush and transferred to the Army. We became Charlie Troop, 101st Air Cavalry. We were assigned to guard a bridge that led to Quang Tri city. Quang Tri city was one of the very few cities that was not hit. Every night we would send out an “outpost” (4 men) and a patrol-ambush team (IQ men). Most of the time both groups would go to a half-intact Catholic Church 100 yards in front of the line. We all would get a very good night's sleep doing this because a turn on watch was only an hour. But of course, we would have to alter our voices for the radio checks, because 2 teams should have been checking in. Not just the one." },
      { tag: "Moral Injury", txt: "I was very lucky not to be a part of any war atrocities. Once a dozen of us were on patrol south of the DMZ along the ocean. The Army was having a large battle about 5 miles away. Tommy Roth, an “Okie from Muskogee”, was point and looked over a rise and saw a bunch of sleeping NVA’s. Someone said, “Shoot ‘em, Tommy, Shoot ‘em.” Tommy shot a bunch of sleeping NVA’s that had never seen combat. We knew this because everything they had was brand new. The only time I had anything new was when I was new. It was wrong, but it wasn’t that long ago that a dozen of our buddies were killed and then head shot just to be sure. War brings us all down to the lowest common denominator." },
      { tag: "War Leaves No One the Same", txt: "War changes us all a little bit; it changes combat veterans a lot. In open fields I still look out for snipers. I still look at my feet to look out for tripwires. Those are very hard habits to break. War movies are too realistic for some of us to watch. I am lucky that I don’t have any nightmares, but many Vets do." },
      { tag: "Starving in the Rain", txt: "Food in combat was normally “C-rations.” Many times, when we were in a somewhat safe zone, we would get 1 hot meal dropped in to us daily. Usually, we would get resupplied every 3 days in the field. We would gorge ourselves and then destroy the leftovers. One time after we got resupplied it really started to rain. It rained 40 inches in 3 days! We had to go for 6 days between meals. We were all really hungry and I remember finding a can of meat that was only half green with mold. I ate the half that wasn’t green." },
      { tag: "Drinking Rice-Paddy Water", txt: "Drinking water, which mostly came from the rice paddies, had been fertilized by humans and animal waste for the past thousand years. This required us to put 3 water purification tablets into the water, though 1 tablet was all that was required by the directions. We would also add lots of Kool-Aid into the water to kill the taste. Occasionally we would get cold milk, but it was usually sour. No one ever threw that cold sour milk out though. A few times when we were without water, we would lick the dew off the leaves to get something wet to drink." },
      { tag: "Death Strikes Again", txt: "Just weeks before I was to go home, we dug in on a mountaintop that was in sight of North Vietnam itself. I was about to “shoot the bull” with my machine-gun buddies, when a round came in and killed Rocky, Archie, and another friend. The round came in from caves in North Vietnam. I missed death by minutes again. That night I went to the LZ (landing zone) and talked to body bags for an hour." },
      { tag: "When Rank Means Nothing", txt: "Once while we were in the rear, a brand-new second lieutenant jumped me for not saluting him. I told him that I don’t salute officers. He next informed me that I WILL SALUTE HIM. “Yessir”, I said, “From now on I will give you a snappy salute and a loud and professional Good Morning or Good Afternoon, whichever is appropriate, and then I will run like hell.” I then briskly walked away. It took him about 30 yards to catch up to me and tell me that I didn’t need to salute him. Wow, sometimes officers can be really dumb." },
      { tag: "Saved by Air Power", txt: "The day the Air Force saved my life. Our platoon (30 men) set up for the night on the edge of a clearing. We were right on the ocean about a mile or so south of the DMZ. In the middle of the night we heard the North Vietnamese digging right across from us. We called in artillery and they would stop digging. Once the shelling stopped, they would start to dig again. So we would have to call in rounds again and they would stop. This went on all night." },
      { tag: "Retreat by Another Name", txt: "We knew “stuff’ would hit the fan at first light. A tank from our base met up with us along with two Huey gunships and two F-4 Phantoms. The F-4’s and Huey gunships made a few gun passes and then the F-4’s dropped Napalm. The Air Force informed us that our platoon and the one tank were up against a NVA regiment, which was roughly 800 men. We next decided to take a tactical advance to the rear. Retreating is not in the Marines’ vocabulary." },
      { tag: "Indescribable Loss", txt: "We only took one casualty that day. A friend -- we were all friends over there -- looked into an enemy’s bunker without throwing in a grenade. He took a round right between the eyes that literally split his head in half. I was told to help evacuate him, but I became too physically ill to do this, so others had to do it." },
      { tag: "Forever Grateful to the F-4s", txt: "So, if it weren’t for those 2 F-4’s, 30 of us would be surrounded with odds not in our favor of about 30 to 1. THANKS, AIR FORCE!" },
      { tag: "Fourth of July Firestorm", txt: "July 4th of 1968 was a very memorable 4th. We were in the middle of a large battle that pitted our 200 men against 500 of the enemy. The enemy stayed to fight because the odds were in their favor. This was a moving battle that played out over acres of land, but when night came a white road separated us. We then called in F-4’s to drop napalm on the enemy’s side of the white road. In the movie “Apocalypse Now”, it was referred that napalm was the smell of victory. To us it was also the “Sight of Victory”. What beautiful fireworks." },
    ];

    // ======= RENDER =======
    const $acc = document.getElementById('accordion');

    items.forEach((it, idx) => {
      const d = document.createElement('details');
      d.dataset.index = idx;
      const s = document.createElement('summary');
      s.innerHTML = `<span class="chev"></span><span class="tagline">${escapeHtml(it.tag)}</span>`;
      const content = document.createElement('div');
      content.className = 'para';
      content.innerHTML = `
        <div class="toolbar">
          <span class="hint">Click any sentence to add a public note.</span>
          <button class="btn-ghost" data-copy>Copy paragraph</button>
        </div>
        <div class="text" data-paragraph="${idx}" aria-label="Paragraph ${idx+1}">${wrapSentences(it.txt, idx)}</div>
        <div class="comments" id="c-${idx}">
          <div class="empty">No public notes yet.</div>
        </div>
      `;
      d.appendChild(s); d.appendChild(content); $acc.appendChild(d);
    });

    // Copy paragraph handler
    $acc.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-copy]');
      if(!btn) return;
      const para = btn.closest('.para').querySelector('.text').innerText;
      navigator.clipboard.writeText(para).then(()=> flashToast('Copied paragraph to clipboard.'));
    });

    // Sentence click → open modal
    $acc.addEventListener('click', (e) => {
      const sent = e.target.closest('.sent');
      if(!sent) return;
      const pIdx = sent.dataset.paragraph;
      const sIdx = sent.dataset.sentence;
      const sTxt = sent.innerText.trim();
      openModal(pIdx, sIdx, sTxt);
    });

    // ======= LOAD & RENDER COMMENTS =======
    async function fetchComments(){
      if(!SCRIPT_URL || SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) return [];
      const res = await fetch(SCRIPT_URL);
      if(!res.ok) return [];
      const data = await res.json();
      return Array.isArray(data)? data: [];
    }

    function renderComments(rows){
      // Group by paragraph_index then by sentence_index
      const byPara = {};
      for(const r of rows){
        const p = Number(r.paragraph_index); const s = Number(r.sentence_index);
        if(Number.isNaN(p)) continue;
        byPara[p] ||= {}; byPara[p][s] ||= [];
        byPara[p][s].push(r);
      }
      for(const [pIdx, bySent] of Object.entries(byPara)){
        const mount = document.getElementById(`c-${pIdx}`);
        if(!mount) continue;
        mount.innerHTML = '';
        for(const [sIdx, arr] of Object.entries(bySent)){
          const section = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'small';
          title.textContent = `Sentence ${Number(sIdx)+1}`;
          section.appendChild(title);
          for(const r of arr){
            const card = document.createElement('div');
            card.className = 'comment';
            const who = obfuscate(r.from_email||'Someone');
            const when = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
            card.innerHTML = `
              <div class="who">${escapeHtml(who)}</div>
              <div class="when">${escapeHtml(when)}</div>
              <div class="text">${escapeHtml(r.note||'')}</div>
              ${r.maintainer_reply? `<div class="reply"><strong>Maintainer reply:</strong> ${escapeHtml(r.maintainer_reply)}${r.reply_timestamp? ` <span class="when">(${escapeHtml(new Date(r.reply_timestamp).toLocaleString())})</span>`:''}</div>`:''}
            `;
            section.appendChild(card);
          }
          mount.appendChild(section);
        }
        if(!mount.children.length){
          mount.innerHTML = '<div class="empty">No public notes yet.</div>';
        }
      }
    }

    // Initial load
    fetchComments().then(renderComments);

    // ======= MODAL =======
    const modal = document.getElementById('noteModal');
    const form = document.getElementById('noteForm');
    const noteText = document.getElementById('noteText');
    const noteEmail = document.getElementById('noteEmail');
    const noteParagraph = document.getElementById('noteParagraph');
    const noteSentence = document.getElementById('noteSentence');
    const noteContext = document.getElementById('noteContext');
    const btnCancel = document.getElementById('btnCancel');

    function openModal(pIdx, sIdx, sTxt){
      noteParagraph.value = String(pIdx);
      noteSentence.value = String(sIdx);
      noteContext.textContent = `Paragraph ${Number(pIdx)+1}, sentence ${Number(sIdx)+1}: “${sTxt}”`;
      noteText.value = '';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> noteText.focus(), 50);
    }
    function closeModal(){ modal.setAttribute('aria-hidden','true'); }
    btnCancel.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const payload = Object.fromEntries(data.entries());
      const body = {
        paragraphIndex: Number(payload.paragraph),
        sentenceIndex: Number(payload.sentence),
        sentenceText: getSentenceText(payload.paragraph, payload.sentence),
        note: payload.note,
        fromEmail: payload.email,
        honeypot: document.getElementById('website').value || ''
      };

      try {
        const ok = await sendNote(body);
        if(ok){ flashToast('✅ Note saved.'); closeModal(); const rows = await fetchComments(); renderComments(rows); }
        else { throw new Error('Send failed'); }
      } catch(err){
        alert('Sorry, could not save your note. Please try again later.');
        closeModal();
      }
    });

  async function sendNote(body){
  if(!SCRIPT_URL || SCRIPT_URL.includes('YOUR_DEPLOYMENT_ID')) return false;

  // Use URL-encoded body and NO custom headers → no preflight
  const params = new URLSearchParams();
  params.set('paragraphIndex', String(body.paragraphIndex));
  params.set('sentenceIndex', String(body.sentenceIndex));
  params.set('sentenceText', body.sentenceText || '');
  params.set('note', body.note || '');
  params.set('fromEmail', body.fromEmail || '');
  params.set('honeypot', body.honeypot || '');

  const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
  // Some GAS deployments return text; parse defensively
  const text = await res.text();
  let j = {};
  try { j = JSON.parse(text); } catch {}
  return res.ok && (j.ok !== false);
}


    function flashToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2400);
    }

    // ======= TEXT UTILS =======
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'
      })[c]);
    }

    function obfuscate(email){
      if(!email) return 'Anonymous';
      const [u,d] = String(email).split('@');
      if(!d) return 'User';
      return u.slice(0,1) + '***@' + d;
    }

    function wrapSentences(txt, pIdx){
      const sentences = splitSentences(txt);
      return sentences.map((s, i)=> `<span class="sent" tabindex="0" data-paragraph="${pIdx}" data-sentence="${i}">${escapeHtml(s)}</span>${i<sentences.length-1?' ':''}`).join('');
    }

    function splitSentences(text){
      const cleaned = text.replace(/\s+/g,' ').trim();
      const parts = cleaned.match(/[^.!?]+[.!?]|[^.!?]+$/g) || [cleaned];
      return parts.map(s=> s.trim());
    }

    function getSentenceText(pIdx, sIdx){
      const i = Number(pIdx); const j = Number(sIdx);
      const sentences = splitSentences(items[i].txt);
      return sentences[j] || '';
    }
  </script>
</body>
</html>
